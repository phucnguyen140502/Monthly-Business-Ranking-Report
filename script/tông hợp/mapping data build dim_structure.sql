 -- fdây dựng bảng dim 
select*from dim_structure ds ;

-- thay đỏi thêm columns cho fact_kpi_month_raw_data
CREATE OR REPLACE PROCEDURE update_fact_txn_month_raw_data()
AS $$
BEGIN
    UPDATE fact_txn_month_raw_data
    SET DVML_HEAD = SPLIT_PART(analysis_code, '.', 1),
        REGION_CODE = SPLIT_PART(analysis_code, '.', 3),
        POS_CDE = SPLIT_PART(analysis_code, '.', 5);
END;
$$ LANGUAGE plpgsql;

CALL update_fact_txn_month_raw_data();
-- update dim_id cho fact_txn_month_raw_data với id table dim_structure, mapping dựa vô đầu của account_code
create or replace procedure update_dim_id()
as $$
begin 
	update fact_txn_month_raw_data 
	set dim_id = 
	CASE
		    WHEN account_code IN (702000030002, 702000030001, 702000030102) THEN 3
		    WHEN account_code IN (702000030012, 702000030112) THEN 4
		    WHEN account_code = 716000000001 THEN 5
		    WHEN account_code = 719000030002 THEN 6
		    WHEN account_code IN (719000030003, 719000030103, 790000030003, 790000030103, 790000030004, 790000030104) THEN 7
		    WHEN account_code = 803000000001 THEN 12
		    WHEN account_code IN (802000000002, 802000000003, 802014000001, 802037000001) THEN 10
		    WHEN account_code IN (801000000001, 802000000001) THEN 11
		    WHEN account_code IN (816000000001, 816000000002, 816000000003) THEN 17
		    WHEN account_code IN (809000000002, 809000000001, 811000000001, 811000000102, 811000000002, 811014000001, 811037000001, 
		    					811039000001, 811041000001, 815000000001, 819000000002, 819000000003, 819000000001, 790000000003, 790000050101, 
		    					790000000101, 790037000001, 849000000001, 899000000003, 899000000002, 811000000101, 819000060001) THEN 18
		    WHEN account_code IN (702000010001, 702000010002, 704000000001, 705000000001, 709000000001, 714000000002, 714000000003, 
		    				714037000001, 714000000004, 714014000001, 715000000001, 715037000001, 719000000001, 709000000101, 719000000101) THEN 16
		    WHEN account_code IN (831000000001, 831000000002, 832000000101, 832000000001, 831000000102) THEN 22
		    WHEN account_code BETWEEN 850000000000 AND 859999999999 THEN 23
		    WHEN account_code BETWEEN 860000000000 AND 869999999999 THEN 24
		    WHEN account_code BETWEEN 870000000000 AND 879999999999 THEN 25
		    WHEN account_code IN (790000050001, 882200050001, 790000030001, 882200030001, 790000000001, 790000020101, 
		    					882200000001, 882200050101, 882200020101, 882200060001, 790000050101, 882200030101) THEN 26
	end;
end;
$$ LANGUAGE plpgsql;

call update_dim_id();




